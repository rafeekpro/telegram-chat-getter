---
name: Message Downloader
status: open
created: 2025-12-29T12:52:49Z
updated: 2025-12-29T12:52:49Z
assigned_agent: .claude/agents/languages/python-backend-engineer.md
agent_context:
  framework: telethon
  language: python
  approach: async message iteration with pagination
github: [Will be updated when synced to GitHub]
depends_on: [002]
parallel: true
conflicts_with: []
---

# Task: Message Downloader

## Description
Implement the core message downloading functionality. Fetch all messages from a specified chat with pagination support for large histories. Handle rate limiting and store message metadata.

## TDD Requirements
**This project uses Test-Driven Development. You MUST:**
1. RED: Write failing test first
2. GREEN: Write minimal code to make test pass
3. REFACTOR: Clean up code while keeping tests green

See `.claude/rules/tdd.enforcement.md` for complete requirements.

## Acceptance Criteria
- [ ] Download messages by chat name or ID
- [ ] Handle pagination for chats with 100K+ messages
- [ ] Respect Telegram rate limits (add delays between batches)
- [ ] Extract message text, sender, timestamp
- [ ] Identify messages with media attachments
- [ ] Store message metadata for later processing
- [ ] Show progress during download

## Technical Details

### CLI Usage
```bash
# Download by chat name
python -m telegram_getter download "Chat Name"

# Download by chat ID
python -m telegram_getter download --id 123456789

# Download with date filter
python -m telegram_getter download "Chat Name" --from 2025-01-01 --to 2025-01-31
```

### Message Data Structure
```python
@dataclass
class Message:
    id: int
    date: datetime
    sender_id: int
    sender_name: str
    text: str
    reply_to: Optional[int]
    media_type: Optional[str]  # photo, audio, video, document
    media_path: Optional[str]  # filled after download
```

### Downloader Implementation
```python
from telethon.tl.types import Message as TelegramMessage

async def download_messages(
    client: TelegramClient,
    chat: str | int,
    from_date: Optional[datetime] = None,
    to_date: Optional[datetime] = None,
    limit: Optional[int] = None,
) -> AsyncIterator[Message]:
    """
    Iterate through all messages in a chat.
    Handles pagination automatically.
    """
    async for message in client.iter_messages(
        chat,
        offset_date=to_date,
        reverse=True,
        limit=limit,
    ):
        if from_date and message.date < from_date:
            continue
        yield parse_message(message)
```

### Rate Limiting
- Use `asyncio.sleep(0.5)` between batches of 100 messages
- Handle FloodWaitError by sleeping for required duration

## Dependencies
- [ ] Task 002: Authentication Module (for Telegram client connection)

## Effort Estimate
- Size: M
- Hours: 4
- Parallel: true (can run alongside task 003)

## Definition of Done
- [ ] Tests written FIRST (RED phase)
- [ ] Code implemented (GREEN phase)
- [ ] Code refactored (REFACTOR phase)
- [ ] All tests passing
- [ ] Messages downloaded correctly
- [ ] Pagination works for large chats
- [ ] Rate limiting prevents API errors
- [ ] Progress shown during download

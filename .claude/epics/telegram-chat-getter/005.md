---
name: Media Downloader
status: open
created: 2025-12-29T12:52:49Z
updated: 2025-12-29T12:52:49Z
assigned_agent: .claude/agents/languages/python-backend-engineer.md
agent_context:
  framework: telethon
  language: python
  approach: async media download with organized folder structure
github: [Will be updated when synced to GitHub]
depends_on: [004]
parallel: false
conflicts_with: []
---

# Task: Media Downloader

## Description
Implement media file downloading for all supported types: images/photos, audio/voice messages, videos, and documents. Organize files in structured folders by media type.

## TDD Requirements
**This project uses Test-Driven Development. You MUST:**
1. RED: Write failing test first
2. GREEN: Write minimal code to make test pass
3. REFACTOR: Clean up code while keeping tests green

See `.claude/rules/tdd.enforcement.md` for complete requirements.

## Acceptance Criteria
- [ ] Download photos/images
- [ ] Download audio files (music, voice messages)
- [ ] Download videos
- [ ] Download documents (PDF, Office files, etc.)
- [ ] Organize files by type in subfolders
- [ ] Name files with date and sequence number
- [ ] Show progress bar for large files
- [ ] Skip already downloaded files (by filename)

## Technical Details

### Output Structure
```
output/{chat-name}/
└── media/
    ├── images/
    │   ├── 2025-01-15_001.jpg
    │   └── 2025-01-15_002.png
    ├── audio/
    │   ├── 2025-01-15_001.ogg
    │   └── 2025-01-15_002.mp3
    ├── video/
    │   └── 2025-01-15_001.mp4
    └── documents/
        ├── report.pdf
        └── data.xlsx
```

### File Naming Convention
- Format: `{date}_{sequence}.{extension}`
- Date: Message date in YYYY-MM-DD format
- Sequence: 3-digit zero-padded number (001, 002, ...)
- Extension: Original file extension or inferred from MIME type

### Implementation
```python
from telethon.tl.types import (
    MessageMediaPhoto,
    MessageMediaDocument,
)

async def download_media(
    client: TelegramClient,
    message: Message,
    output_dir: Path,
) -> Optional[str]:
    """Download media from a message, return relative path."""
    if not message.media:
        return None

    media_type = get_media_type(message.media)
    media_dir = output_dir / "media" / media_type
    media_dir.mkdir(parents=True, exist_ok=True)

    filename = generate_filename(message)
    filepath = media_dir / filename

    if filepath.exists():
        return str(filepath.relative_to(output_dir))

    await client.download_media(
        message,
        file=filepath,
        progress_callback=show_progress,
    )
    return str(filepath.relative_to(output_dir))
```

### Media Type Detection
```python
def get_media_type(media) -> str:
    if isinstance(media, MessageMediaPhoto):
        return "images"
    elif isinstance(media, MessageMediaDocument):
        mime = media.document.mime_type
        if mime.startswith("audio"):
            return "audio"
        elif mime.startswith("video"):
            return "video"
        else:
            return "documents"
    return "other"
```

## Dependencies
- [ ] Task 004: Message Downloader (for message iteration)

## Effort Estimate
- Size: M
- Hours: 4
- Parallel: false

## Definition of Done
- [ ] Tests written FIRST (RED phase)
- [ ] Code implemented (GREEN phase)
- [ ] Code refactored (REFACTOR phase)
- [ ] All tests passing
- [ ] All media types download correctly
- [ ] Files organized in proper folders
- [ ] Progress shown for large files
- [ ] Duplicate downloads skipped
